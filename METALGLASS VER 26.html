<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orçamento e Contrato METALGLASS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        /* Estilos Customizados para Impressão */
        @media print {
            .print\:hidden {
                display: none !important;
            }
            body {
                margin: 0;
                padding: 0;
            }
            .container-page {
                box-shadow: none !important;
                border: none !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 1cm !important;
                break-after: page;
                position: relative !important;
            }
            .container-page:last-of-type {
                break-after: auto;
            }
            .print-input, .print-textarea {
                border: none !important;
                background: transparent !important;
                resize: none !important;
                padding: 0 !important;
                box-shadow: none !important;
                min-height: 1.2em;
                line-height: 1.5;
                text-indent: 0 !important;
            }
            .print-textarea {
                display: block;
                height: auto !important;
                overflow: hidden !important;
            }
            /* Garantir que o input dentro do campo logístico não tenha borda extra no print */
            #pagina-1 input:not(.print-input):not(#data_instalacao) {
                border-bottom: 1px solid #000 !important;
                font-weight: bold;
                border-radius: 0 !important;
            }
            .print-input {
                border: none !important;
            }
            #tabela_itens tr {
                page-break-inside: avoid;
            }
            .page-number-visible {
                position: absolute;
                bottom: 0.5cm;
                left: 50%;
                transform: translateX(-50%);
                font-size: 10pt;
                color: #555;
                font-weight: 500;
            }
            /* Manter o destaque do campo logístico no print */
            .border-black {
                border: 1px solid #000 !important;
            }
            .bg-red-500 {
                background-color: #ef4444 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .text-white {
                color: #fff !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            /* Estilo para garantir que as cláusulas ocupem 100% da largura na impressão */
            .clausula-item {
                display: flex;
                flex-direction: row;
                align-items: flex-start;
            }
            .clausula-numero {
                min-width: 40px; /* Espaço para o número (I. II. III.) */
                font-weight: bold;
                margin-right: 5px;
            }
            .clausula-texto-area {
                width: 100% !important;
            }
        }

        /* Estilos para a tela/aplicação */
        .font-contract {
            font-family: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif;
        }
        .signature-canvas {
            /* Essencial para dispositivos touch: garante que apenas o canvas lide com o toque */
            touch-action: none; 
            border: 1px solid #ddd;
            background-color: #fff;
            width: 100%;
            height: 200px;
        }
        .auto-resize {
            resize: none;
            overflow: hidden;
            min-height: 1.2em;
        }
        .page-number-visible {
            display: block;
            margin-top: 1.5rem;
            text-align: center;
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* text-gray-600 */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['ui-serif', 'Georgia', 'Cambria', 'Times New Roman', 'Times', 'serif'],
                    },
                },
            },
        };
    </script>
</head>
<body class="bg-gray-100 p-4 md:p-8 font-sans">

    <div class="mx-auto max-w-6xl">

        <div id="pagina-1" class="container-page bg-white shadow-xl rounded-lg p-6 md:p-10 mb-8 relative">
            <header class="mb-8 border-b pb-4">
                <div class="flex flex-col md:flex-row justify-between items-start">
                    
                    <div class="flex flex-col items-center md:items-start mb-4 md:mb-0">
                        <img src="https://placehold.co/250x90/1e40af/ffffff?text=METALGLASS"
                            alt="Logo METALGLASS" class="w-48 h-auto mb-3 rounded-lg">
                        
                        <div class="text-left text-sm">
                            <p class="font-semibold text-gray-700 flex items-center mb-1">Empresa:
                                <input type="text" id="empresa_nome" value="METALGLASS" class="print-input font-bold ml-1 w-32 md:w-40 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-0.5 text-base" oninput="atualizarDadosContrato()">
                            </p>
                            <p class="text-gray-600 flex items-center mb-1">CNPJ:
                                <input type="text" id="empresa_cnpj" value="24.298.057/0001-87" class="print-input ml-1 w-32 md:w-40 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-0.5 text-base" oninput="atualizarDadosContrato()">
                            </p>
                            <p class="text-gray-600 flex items-center">Telefone:
                                <input type="text" id="empresa_telefone" value="24-99301-5795" class="print-input ml-1 w-32 md:w-40 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-0.5 text-base" readonly>
                            </p>
                        </div>
                    </div>

                    <div class="flex flex-col items-center md:items-end">
                        <div class="text-sm font-extrabold text-gray-800 bg-gray-100 p-4 rounded-lg shadow-xl mb-4 tracking-wider">ORÇAMENTO</div>
                        <div class="text-sm text-gray-700 text-center md:text-right">
                            <p class="mt-2"><span class="font-medium">Data do Orçamento:</span>
                                <span id="data_hora_atual" class="font-bold text-blue-600"></span>
                            </p>
                        </div>
                    </div>
                </div>
            </header>
        
            <section class="mb-8 p-4 border rounded-lg bg-blue-50/50">
                <h2 class="text-lg font-semibold mb-3 text-blue-700">Dados do Cliente</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                    <label class="block sm:col-span-2 lg:col-span-1">
                        <span class="text-gray-600 font-medium">Nome:</span>
                        <input type="text" id="nome_cliente" oninput="atualizarDadosContrato()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="Nome Completo">
                    </label>
                    <label class="block">
                        <span class="text-gray-600 font-medium">Data de Nascimento:</span>
                        <input type="date" id="data_nascimento_cliente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="DD/MM/AAAA">
                    </label>
                    <label class="block">
                        <span class="text-gray-600 font-medium">CPF:</span>
                        <input type="text" id="cpf_cliente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="000.000.000-00">
                    </label>
                    <label class="block">
                        <span class="text-gray-600 font-medium">RG ou CNH:</span>
                        <input type="text" id="rg_cnh_cliente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="Identidade ou Habilitação">
                    </label>
                    
                    <label class="block">
                        <span class="text-gray-600 font-medium">Telefone:</span>
                        <input type="text" id="telefone_cliente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="(XX) XXXXX-XXXX">
                    </label>
                    <label class="block sm:col-span-2 lg:col-span-1">
                        <span class="text-gray-600 font-medium">E-mail:</span>
                        <input type="email" id="email_cliente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="email@exemplo.com">
                    </label>
                    
                    <label class="block sm:col-span-2 lg:col-span-2">
                        <span class="text-gray-600 font-medium">Melhor Dia e Data para Instalação:</span>
                        <div class="flex items-center mt-1 border border-black rounded-lg overflow-hidden">
                            <input type="text" id="data_instalacao" 
                                class="block w-full border-none shadow-none focus:ring-0 focus:border-transparent p-2 print-input" 
                                placeholder="Ex: Segunda-feira, 15/07">
                            <span class="bg-red-500 text-white text-xs font-bold py-2 px-4 whitespace-nowrap text-center" 
                                title="A disponibilidade deve ser confirmada pela empresa.">
                                A DEPENDER DA DISPONIBILIDADE
                            </span>
                        </div>
                    </label>

                    <label class="block">
                        <span class="text-gray-600 font-medium">CEP:</span>
                        <input type="text" id="cep_cliente" 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" 
                            placeholder="00000-000" maxlength="9" 
                            oninput="formatarCep(this)" 
                            onblur="buscarCep(this.value)"> 
                    </label>
                    <label class="block sm:col-span-2 lg:col-span-2">
                        <span class="text-gray-600 font-medium">Rua / Av.:</span>
                        <input type="text" id="endereco_cliente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="Nome da Rua/Avenida">
                    </label>
                    <label class="block">
                        <span class="text-gray-600 font-medium">Número:</span>
                        <input type="text" id="numero_cliente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="1234">
                    </label>
                    
                    <label class="block">
                        <span class="text-gray-600 font-medium">Bairro:</span>
                        <input type="text" id="bairro_cliente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="Ex: Centro">
                    </label>
                     <label class="block">
                        <span class="text-gray-600 font-medium">Cidade:</span>
                        <input type="text" id="cidade_cliente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="Ex: Rio de Janeiro">
                    </label>
                    <label class="block sm:col-span-2">
                        <span class="text-gray-600 font-medium">Ponto de Referência:</span>
                        <input type="text" id="referencia_cliente" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="Ex: Próximo à padaria">
                    </label>
                   
                </div>
            </section>
            
            <span class="page-number-visible" id="page-num-1">Página 1 de 3</span>
        </div>

        <div id="pagina-2" class="container-page bg-white shadow-xl rounded-lg p-6 md:p-10 mb-8 relative">
            <div id="detalhes_itens_container" class="mb-8">
                <h2 class="text-lg font-semibold mb-3 text-blue-700">Detalhes dos Itens</h2>
                <div class="overflow-x-auto rounded-lg border">
                    <table class="min-w-full table-auto divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12 min-w-[50px]">Qtd</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-7/12 min-w-[200px]">Descrição do Item</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-3/12 min-w-[120px]">Valor (R$)</th>
                                <th scope="col" class="px-3 py-3 print:hidden w-auto"></th>
                            </tr>
                        </thead>
                        <tbody id="tabela_itens" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            
                <div class="mt-4 print:hidden">
                    <button onclick="adicionarLinha()" class="flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        Adicionar Item
                    </button>
                </div>
            </div>
            <section class="flex justify-end mt-8">
                <div class="w-full md:w-1/2 lg:w-1/3 p-4 border rounded-lg bg-gray-50 shadow-inner">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-lg font-medium text-gray-600">Subtotal:</span>
                        <span id="subtotal" class="text-lg font-bold text-gray-800">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between items-center pt-3 mt-3 border-t-2 border-blue-500">
                        <span class="text-2xl font-extrabold text-blue-800">TOTAL GERAL:</span>
                        <span id="total_geral" class="text-2xl font-extrabold text-blue-800">R$ 0,00</span>
                    </div>
                </div>
            </section>
            
            <span class="page-number-visible" id="page-num-2">Página 2 de 3</span>
        </div>

        <div id="contrato-view" class="container-page bg-white shadow-xl rounded-lg p-6 md:p-10 font-contract mt-8 relative">
            <header class="text-center mb-6 pt-4 border-b-2 border-gray-900">
                <h1 class="text-xl md:text-2xl font-bold text-gray-900 uppercase tracking-wider mb-2">
                    CONTRATO DE PRESTAÇÃO DE SERVIÇOS METAL GLASS
                </h1>
                <p class="text-sm text-gray-600 mb-2">
                    <span id="contrato_cnpj">24.298.057/0001-87</span> | Telefone: <span id="contrato_telefone">24-99301-5795</span>
                </p>
            </header>

            <section class="mb-4 text-base leading-relaxed overflow-y-auto max-h-full">
                
                <h2 class="mb-3 text-lg font-bold text-gray-800">PARTES CONTRATANTES:</h2>
                
                <div class="clausula-item mb-2">
                    <span class="clausula-numero font-bold">I.</span>
                    <textarea id="clausula_contratante" rows="2" class="clausula-texto-area w-full auto-resize print-textarea border border-gray-300 p-1 focus:border-blue-500" oninput="autoResizeTextarea(this)">CONTRATANTE: [NOME DO CLIENTE], doravante denominado CLIENTE, com endereço e dados de contato informados no Orçamento anexo.</textarea>
                </div>
                
                <div class="clausula-item mb-4">
                    <span class="clausula-numero font-bold">II.</span>
                    <textarea id="clausula_contratada" rows="2" class="clausula-texto-area w-full auto-resize print-textarea border border-gray-300 p-1 focus:border-blue-500" oninput="autoResizeTextarea(this)">CONTRATADA: METALGLASS, CNPJ 24.298.057/0001-87, doravante denominada EMPRESA.</textarea>
                </div>

                <h2 class="mb-3 text-lg font-bold text-gray-800 mt-6">DO OBJETO E CONDIÇÕES:</h2>

                <div class="clausula-item mb-4">
                    <span class="clausula-numero font-bold">III.</span>
                    <textarea id="clausula_objeto" rows="3" class="clausula-texto-area w-full auto-resize print-textarea border border-gray-300 p-1 focus:border-blue-500" oninput="autoResizeTextarea(this)">O presente contrato tem por objeto a prestação de serviços de fornecimento e instalação de vidros temperados, esquadrias e/ou itens de serralheria, conforme detalhado na Tabela de Itens do Orçamento anexo (totalizando R$ 0,00).</textarea>
                </div>
                
                <div class="clausula-item mb-4">
                    <span class="clausula-numero font-bold">IV.</span>
                    <textarea id="clausula_prazo" rows="8" class="clausula-texto-area w-full auto-resize print-textarea border border-gray-300 p-1 focus:border-blue-500" oninput="autoResizeTextarea(this)">Validade do Orçamento: 7 dias corridos após o envio. O prazo para execução do serviço é de 30 dias após a data do pagamento. A execução depende das condições climáticas e de acesso. O local deverá estar liberado para o serviço. Em caso de ocupação, será concedido prazo de 1 hora para liberação, sob pena de cobrança adicional de transporte e estadia da equipe.</textarea>
                </div>
                
                <div class="clausula-item mb-4">
                    <span class="clausula-numero font-bold">V.</span>
                    <textarea id="clausula_pagamento" rows="3" class="clausula-texto-area w-full auto-resize print-textarea border border-gray-300 p-1 focus:border-blue-500" oninput="autoResizeTextarea(this)">O valor total dos serviços é o especificado na folha de Orçamentos. Condições de pagamento: 50% no aceite e 50% na conclusão da instalação, ou no cartão sujeito às condições de parcelamento da empresa. O não pagamento de qualquer parcela sujeitará o CLIENTE às sanções legais.</textarea>
                </div>
                
                <div class="clausula-item mb-4">
                    <span class="clausula-numero font-bold">VI.</span>
                    <textarea id="clausula_garantia" rows="2" class="clausula-texto-area w-full auto-resize print-textarea border border-gray-300 p-1 focus:border-blue-500" oninput="autoResizeTextarea(this)">A garantia dos materiais e da mão de obra será de 90 dias, conforme Código de Defesa do Consumidor, exceto em casos de mau uso, acidentes ou desgaste natural.</textarea>
                </div>
                
                <p class="mb-4 text-center mt-6 text-gray-800 font-bold italic">
                    <textarea id="clausula_encerramento" rows="1" class="w-full text-center auto-resize print-textarea border border-gray-300 p-1 focus:border-blue-500" oninput="autoResizeTextarea(this)">E por estarem justos e contratados, assinam o presente em duas vias de igual teor.</textarea>
                </p>
            </section>

            <section class="mt-10 p-4">
                
                <div class="mb-5 text-center text-sm font-contract">
                    <p>
                        <span class="font-bold">Local:</span>
                        <input type="text" value="[Cidade/Estado]" class="underline w-32 text-center print-input" id="contrato_local">
                        , <span class="font-bold">Data:</span> <span id="contrato_data_extenso" class="underline"></span>
                    </p>
                </div>
                
                <div class="flex flex-col items-center justify-center space-y-2 mb-8 print:hidden">
                    <div class="flex space-x-4">
                        <button onclick="salvarContrato()" id="botao_salvar_contrato" class="px-4 py-2 text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                            Salvar Alterações
                        </button>
                        <button onclick="editarContrato()" id="botao_editar_contrato" class="px-4 py-2 text-sm font-medium rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-150 ease-in-out">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            Editar Contrato
                        </button>
                    </div>
                    <span id="status_edicao" class="text-xs text-gray-500 italic mt-2"></span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    
                    <div>
                        <p class="text-center text-sm mb-2 text-gray-700">Assinatura do CLIENTE:</p>
                        <div class="relative">
                            <canvas id="signatureCanvasClient" class="signature-canvas rounded-lg shadow-inner"></canvas>
                            <div id="overlayClient" class="absolute inset-0 bg-gray-100 bg-opacity-50 hidden items-center justify-center rounded-lg">
                            </div>
                        </div>
                        <div id="controlsClient" class="text-center mt-2 print:hidden space-x-2">
                            <button onclick="limparAssinatura('client')" class="text-xs text-red-600 hover:text-red-800 transition duration-150 ease-in-out font-medium p-1 rounded-md border border-red-300 hover:bg-red-50">
                                Limpar Assinatura
                            </button>
                            <button onclick="salvarAssinatura('client')" class="text-xs text-green-600 hover:text-green-800 transition duration-150 ease-in-out font-medium p-1 rounded-md border border-green-300 hover:bg-green-50">
                                Salvar Assinatura
                            </button>
                        </div>
                        <div id="statusClient" class="text-center mt-2 print:hidden hidden">
                            <span class="text-xs text-green-700 font-bold bg-green-100 border border-green-300 p-1 rounded-md">Assinatura Salva e Bloqueada</span>
                        </div>
                        <p class="text-center text-sm mt-3 text-gray-500 font-bold">
                            Nome: <span id="cliente_assinatura_nome" class="text-gray-700">_________________________</span>
                        </p>
                    </div>
                    
                    <div>
                        <p class="text-center text-sm mb-2 text-gray-700">Assinatura da EMPRESA:</p>
                        <div class="relative">
                            <canvas id="signatureCanvasCompany" class="signature-canvas rounded-lg shadow-inner"></canvas>
                              <div id="overlayCompany" class="absolute inset-0 bg-gray-100 bg-opacity-50 hidden items-center justify-center rounded-lg">
                            </div>
                        </div>
                          <div id="controlsCompany" class="text-center mt-2 print:hidden space-x-2">
                            <button onclick="limparAssinatura('company')" class="text-xs text-red-600 hover:text-red-800 transition duration-150 ease-in-out font-medium p-1 rounded-md border border-red-300 hover:bg-red-50">
                                Limpar Assinatura
                            </button>
                            <button onclick="salvarAssinatura('company')" class="text-xs text-green-600 hover:text-green-800 transition duration-150 ease-in-out font-medium p-1 rounded-md border border-green-300 hover:bg-green-50">
                                Salvar Assinatura
                            </button>
                        </div>
                          <div id="statusCompany" class="text-center mt-2 print:hidden hidden">
                            <span class="text-xs text-green-700 font-bold bg-green-100 border border-green-300 p-1 rounded-md">Assinatura Salva e Bloqueada</span>
                        </div>
                        <p class="text-center text-sm mt-3 text-gray-500 font-bold">
                            Nome:
                            <input type="text" id="empresa_assinatura_nome" value="METALGLASS (Representante Legal)" class="text-gray-700 print-input text-center font-bold w-48 focus:border-blue-500">
                        </p>
                    </div>
                </div>
            </section>
            
            <span class="page-number-visible" id="page-num-3">Página 3 de 3</span>
        </div>

        <section class="mt-10 pt-6 border-t print:hidden flex justify-center space-x-4">
            <button onclick="imprimirPagina()" class="flex items-center px-8 py-3 border border-transparent text-base font-medium rounded-lg shadow-xl text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition duration-150 ease-in-out">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m0 0v3a2 2 0 002 2h4a2 2 0 002-2v-3m-2-4h-4m4 4h-4"></path></svg>
                Imprimir Orçamento e Contrato
            </button>
             <button onclick="salvarHtml()" class="flex items-center px-8 py-3 border border-transparent text-base font-medium rounded-lg shadow-xl text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-300 transition duration-150 ease-in-out">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h4l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path></svg>
                Salvar Arquivo
            </button>
        </section>

        <footer class="mt-8 pt-4 border-t border-gray-200 flex justify-center items-center print:hidden">
            <img src="https://placehold.co/100x35/1e40af/ffffff?text=METALGLASS"
                alt="Logo METALGLASS" class="w-24 h-auto opacity-75">
        </footer>
    </div>

    <div id="customAlertModal" class="print:hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4" id="customAlertTitle">Aviso</h3>
            <p class="text-sm text-gray-600 mb-6" id="customAlertMessage"></p>
            <div class="flex justify-end">
                <button onclick="hideAlert()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">OK</button>
            </div>
        </div>
    </div>

    <div id="customConfirmModal" class="print:hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4" id="customConfirmTitle">Confirmação</h3>
            <p class="text-sm text-gray-600 mb-6 whitespace-pre-line" id="customConfirmMessage"></p>
            <div class="flex justify-end space-x-3">
                <button onclick="cancelConfirm()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">Cancelar</button>
                <button onclick="acceptConfirm()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Confirmar</button>
            </div>
        </div>
    </div>
    <script>
        let linhaIdCounter = 0;
        const signaturePads = {};
        
        let confirmCallback = null;

        // --- FUNÇÕES GERAIS E UTILS ---

        const stringToNumber = (text) => {
            // Converte o formato brasileiro (milhar com ponto, decimal com vírgula) para formato numérico (ponto)
            const cleaned = String(text).replace(/\./g, '').replace(',', '.');
            return parseFloat(cleaned) || 0;
        };

        const formatarMoeda = (valor) => {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                useGrouping: true,
            }).format(valor);
        };

        const getDataExtenso = () => {
            const now = new Date();
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return now.toLocaleDateString('pt-BR', options);
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function atualizarDataHora() {
            const now = new Date();
            const dia = now.getDate().toString().padStart(2, '0');
            const mes = (now.getMonth() + 1).toString().padStart(2, '0');
            const ano = now.getFullYear();
            const horas = now.getHours().toString().padStart(2, '0');
            const minutos = now.getMinutes().toString().padStart(2, '0');
            
            document.getElementById('data_hora_atual').textContent = `${dia}/${mes}/${ano} ${horas}:${minutos}`;
            document.getElementById('contrato_data_extenso').textContent = getDataExtenso();
        }
        
        // --- FUNÇÕES DE BUSCA CEP ---

        function formatarCep(input) {
            let value = input.value.replace(/\D/g, ''); // Remove tudo que não é dígito
            if (value.length > 5) {
                value = value.substring(0, 5) + '-' + value.substring(5, 8);
            }
            input.value = value;
        }

        function buscarCep(cep) {
            const cepLimpo = cep.replace(/\D/g, '');

            if (cepLimpo.length !== 8) {
                // Limpa campos se o CEP for inválido ou incompleto
                document.getElementById('endereco_cliente').value = '';
                document.getElementById('bairro_cliente').value = '';
                document.getElementById('cidade_cliente').value = '';
                return;
            }

            // 1. Limpa os campos antes de iniciar a busca
            document.getElementById('endereco_cliente').value = 'Buscando...';
            document.getElementById('bairro_cliente').value = 'Buscando...';
            document.getElementById('cidade_cliente').value = 'Buscando...';
            
            // Bloqueia temporariamente para evitar digitação manual durante a busca
            document.getElementById('endereco_cliente').readOnly = true;
            document.getElementById('bairro_cliente').readOnly = true;
            document.getElementById('cidade_cliente').readOnly = true;

            // Usando a API gratuita ViaCEP
            const url = `https://viacep.com.br/ws/${cepLimpo}/json/`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // 2. Desbloqueia os campos após a resposta
                    document.getElementById('endereco_cliente').readOnly = false;
                    document.getElementById('bairro_cliente').readOnly = false;
                    document.getElementById('cidade_cliente').readOnly = false;

                    if (data.erro) {
                        // CEP não encontrado
                        document.getElementById('endereco_cliente').value = '';
                        document.getElementById('bairro_cliente').value = '';
                        document.getElementById('cidade_cliente').value = '';
                        showAlert('Atenção', `O CEP **${cep}** não foi encontrado. Por favor, preencha manualmente.`);
                    } else {
                        // 3. Preenche os campos, usando string vazia se o dado não existir (Correção principal)
                        document.getElementById('endereco_cliente').value = data.logradouro || '';
                        document.getElementById('bairro_cliente').value = data.bairro || '';
                        document.getElementById('cidade_cliente').value = data.localidade || ''; 
                        
                        // 4. Se o logradouro estiver vazio, alerta o usuário (confirma o comportamento esperado de um CEP genérico)
                        if (!data.logradouro || data.logradouro.trim() === '') {
                             showAlert('Informação', `O CEP **${cep}** é um CEP geral da localidade. Por favor, digite o nome da rua e o número.`);
                             // Foca no endereço para preenchimento manual
                             document.getElementById('endereco_cliente').focus();
                        } else {
                            // Foca no campo número, já que o endereço foi preenchido
                            document.getElementById('numero_cliente').focus();
                        }
                    }
                })
                .catch(error => {
                    // Em caso de erro na requisição, limpa e desbloqueia
                    document.getElementById('endereco_cliente').readOnly = false;
                    document.getElementById('bairro_cliente').readOnly = false;
                    document.getElementById('cidade_cliente').readOnly = false;
                    document.getElementById('endereco_cliente').value = '';
                    document.getElementById('bairro_cliente').value = '';
                    document.getElementById('cidade_cliente').value = '';
                    
                    console.error('Erro na busca de CEP:', error);
                    showAlert('Erro', 'Houve um erro ao tentar buscar o CEP. Tente novamente ou preencha manualmente.');
                });
        }

        // --- FUNÇÕES DE ITENS E TOTAIS ---

        function calcularTotais() {
            const tabela = document.getElementById('tabela_itens');
            let subtotal = 0;
            
            tabela.querySelectorAll('tr').forEach(row => {
                const inputValor = row.querySelector('.input-valor');
                const inputQuantidade = row.querySelector('.input-quantidade');
                
                if (inputValor && inputQuantidade) {
                    // Obtém o valor unitário
                    const valorUnitario = stringToNumber(inputValor.value);
                    // Obtém a quantidade
                    const quantidade = parseInt(inputQuantidade.value) || 0; 
                    
                    // Calcula o total da linha: Quantidade * Valor Unitário
                    const totalLinha = valorUnitario * quantidade; 
                    
                    subtotal += totalLinha;
                }
            });

            const valorFormatado = formatarMoeda(subtotal);
            document.getElementById('subtotal').textContent = valorFormatado;
            document.getElementById('total_geral').textContent = valorFormatado;
            
            // ATUALIZAÇÃO SEGURA DA CLÁUSULA PRIMEIRA
            const clausulaObjeto = document.getElementById('clausula_objeto');
            if (clausulaObjeto) {
                // Usa Regex para encontrar e substituir APENAS a parte do valor: (totalizando R$ [qualquer valor])
                const regexValor = /(\(totalizando\s+R\$\s*[^)]+\))/i;
                const valorPlaceholder = `(totalizando ${valorFormatado})`;
                
                let novoTexto = clausulaObjeto.value;
                
                if (novoTexto.match(regexValor)) {
                     // 1. Se o padrão for encontrado, substitui SÓ o valor dinamicamente
                    novoTexto = novoTexto.replace(regexValor, valorPlaceholder);
                } else {
                    // 2. Se o padrão for apagado pelo usuário, mas o valor ainda não está lá
                    if (!clausulaObjeto.value.includes('totalizando')) {
                         novoTexto = clausulaObjeto.value.trim().replace(/\s*$/, '') + ` ${valorPlaceholder}`;
                    }
                }
                
                clausulaObjeto.value = novoTexto;
                autoResizeTextarea(clausulaObjeto);
            }
        }

        function adicionarLinha() {
            linhaIdCounter++;
            const tabela = document.getElementById('tabela_itens');
            const newRow = tabela.insertRow();
            newRow.id = `linha-${linhaIdCounter}`;
            newRow.className = 'hover:bg-gray-50';

            const celulaQtd = newRow.insertCell();
            celulaQtd.className = 'px-3 py-2 whitespace-nowrap text-sm text-gray-500';
            // Adiciona o evento oninput para chamar calcularTotais() quando a quantidade mudar
            celulaQtd.innerHTML = `<input type="number" value="1" min="1" class="w-10 text-center border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 p-1 input-quantidade print-input" oninput="calcularTotais()">`;

            const celulaDescricao = newRow.insertCell();
            celulaDescricao.className = 'px-6 py-2 whitespace-normal text-sm font-medium text-gray-900';
            celulaDescricao.innerHTML = `<textarea rows="1" class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 p-1 auto-resize print-textarea" oninput="autoResizeTextarea(this);"></textarea>`;
            autoResizeTextarea(celulaDescricao.querySelector('textarea'));

            const celulaValor = newRow.insertCell();
            celulaValor.className = 'px-6 py-2 whitespace-nowrap text-sm text-gray-900 text-right font-semibold';
            // O input-valor agora chama a função formatarInputMoeda CORRIGIDA
            celulaValor.innerHTML = `<input type="text" value="0,00" class="w-28 text-right border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 p-1 input-valor print-input" oninput="this.value = formatarInputMoeda(this.value); calcularTotais();">`;

            const celulaAcao = newRow.insertCell();
            celulaAcao.className = 'px-3 py-2 whitespace-nowrap text-right text-sm font-medium print:hidden';
            celulaAcao.innerHTML = `<button onclick="removerLinha('${newRow.id}')" class="text-red-600 hover:text-red-900 p-1 rounded-full hover:bg-red-50 transition duration-150 ease-in-out"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>`;
            
            calcularTotais();
        }

        function removerLinha(id) {
            const linha = document.getElementById(id);
            if (linha) {
                linha.remove();
                calcularTotais();
            }
        }
        
        // --- FUNÇÃO DE FORMATAÇÃO DE MOEDA NO INPUT (CORRIGIDA) ---
        function formatarInputMoeda(numero) {
            // 1. Remove tudo exceto dígitos e a primeira vírgula (mantendo-a como separador decimal)
            let valor = numero.replace(/[^\d,]/g, '');

            // 2. Garante que só há uma vírgula (substitui a primeira vírgula por um marcador temporário e remove as restantes)
            const partes = valor.split(',');
            if (partes.length > 2) {
                valor = partes[0] + ',' + partes.slice(1).join('');
            }

            // Se o valor for vazio, retorna string vazia
            if (!valor) return '';

            // 3. Divide a string em parte inteira e parte decimal (se houver vírgula)
            if (valor.includes(',')) {
                const partesSeparadas = valor.split(',');
                let inteiro = partesSeparadas[0];
                let decimal = partesSeparadas[1];
                
                // Formata a parte inteira (separador de milhar com ponto)
                inteiro = inteiro.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                
                // Limita a 2 casas decimais, mas não impede a digitação
                decimal = decimal.substring(0, 2);
                
                valor = inteiro + ',' + decimal;

            } else {
                // Se não há vírgula, formata apenas a parte inteira (separador de milhar com ponto)
                valor = valor.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            }

            return valor;
        }

        // --- FUNÇÕES DE CONTRATO ---

        function atualizarDadosContrato() {
            const nomeCliente = document.getElementById('nome_cliente').value || '[NOME DO CLIENTE]';
            const nomeEmpresa = document.getElementById('empresa_nome').value || 'METALGLASS';
            const cnpjEmpresa = document.getElementById('empresa_cnpj').value || '24.298.057/0001-87';
            const telefoneEmpresa = document.getElementById('empresa_telefone').value || '24-99301-5795';

            document.getElementById('clausula_contratante').value = `CONTRATANTE: ${nomeCliente}, doravante denominado CLIENTE, com endereço e dados de contato informados no Orçamento anexo.`;
            document.getElementById('clausula_contratada').value = `CONTRATADA: ${nomeEmpresa}, CNPJ ${cnpjEmpresa}, doravante denominada EMPRESA.`;
            document.getElementById('contrato_cnpj').textContent = cnpjEmpresa;
            document.getElementById('contrato_telefone').textContent = telefoneEmpresa;
            document.getElementById('cliente_assinatura_nome').textContent = nomeCliente.toUpperCase() || '_________________________';

            // Garante que o resize seja refeito
            document.querySelectorAll('.auto-resize').forEach(autoResizeTextarea);
            
            calcularTotais(); // Garante que o valor total na CLÁUSULA PRIMEIRA esteja atualizado
        }

        let contratoEditavel = false;

        function toggleContratoEdicao(habilitar) {
            // Seleciona as textareas dentro da seção do contrato
            const textareas = document.querySelectorAll('#contrato-view textarea');
            const statusEdicao = document.getElementById('status_edicao');
            
            textareas.forEach(textarea => {
                textarea.readOnly = !habilitar;
                if (habilitar) {
                    textarea.classList.remove('print-textarea');
                    textarea.classList.add('border', 'border-gray-300');
                    textarea.style.border = ''; // Remove o inline style forçado para print/readonly
                } else {
                    textarea.classList.remove('border', 'border-gray-300');
                    textarea.classList.add('print-textarea');
                }
                autoResizeTextarea(textarea); // Redimensiona ao mudar o modo
            });

            if (habilitar) {
                statusEdicao.textContent = 'Contrato em modo de Edição. Lembre-se de salvar.';
            } else {
                statusEdicao.textContent = 'Contrato bloqueado. Clique em "Editar Contrato" para modificar.';
            }
            
            document.getElementById('botao_salvar_contrato').classList.toggle('hidden', !habilitar);
            document.getElementById('botao_editar_contrato').classList.toggle('hidden', habilitar);
        }

        function salvarContrato() {
            toggleContratoEdicao(false);
            showAlert('Sucesso', 'As alterações no Contrato foram salvas e ele foi bloqueado para visualização.');
        }

        function editarContrato() {
            toggleContratoEdicao(true);
        }

        // --- FUNÇÕES DE ASSINATURA ---
        
        function inicializarAssinaturas() {
            const canvasClient = document.getElementById('signatureCanvasClient');
            const canvasCompany = document.getElementById('signatureCanvasCompany');

            const signatureOptions = {
                throttle: 0, 
                minDistance: 1, 
                velocityFilterWeight: 0.7, 
                dotSize: 1.5,
                penColor: 'rgb(0, 0, 0)'
            };

            signaturePads.client = new SignaturePad(canvasClient, signatureOptions);
            signaturePads.company = new SignaturePad(canvasCompany, signatureOptions);

            resizeCanvas(canvasClient);
            resizeCanvas(canvasCompany);
        }

        function resizeCanvas(canvas) {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            const parent = canvas.parentElement;
            
            canvas.width = parent.clientWidth * ratio;
            canvas.height = parent.clientHeight * ratio;
            canvas.getContext('2d').scale(ratio, ratio);
            
            const id = canvas.id.includes('Client') ? 'client' : 'company';
            const savedData = canvas.getAttribute('data-signature');
            if (savedData && signaturePads[id]) {
                signaturePads[id].fromDataURL(savedData);
                signaturePads[id].off();
            } else if (signaturePads[id]) {
                signaturePads[id].clear();
                signaturePads[id].on();
            }
        }

        function limparAssinatura(type) {
            if (signaturePads[type]) {
                if (document.getElementById(`overlay${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.contains('flex')) {
                    showConfirm('Confirmar Limpeza', 'Deseja realmente limpar e desbloquear a assinatura? Isso removerá a imagem salva.', () => {
                        signaturePads[type].clear();
                        signaturePads[type].on(); 
                        document.getElementById(`overlay${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('hidden');
                        document.getElementById(`overlay${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.remove('flex');
                        document.getElementById(`controls${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.remove('hidden');
                        document.getElementById(`status${type.charAt(0).toUpperCase() + type.slice(1)}`).classList.add('hidden');
                        document.getElementById(`signatureCanvas${type.charAt(0).toUpperCase() + type.slice(1)}`).removeAttribute('data-signature');
                    });
                } else {
                    signaturePads[type].clear();
                }
            }
        }

        function salvarAssinatura(type) {
            if (signaturePads[type].isEmpty()) {
                showAlert('Atenção', 'O campo de assinatura está vazio. Por favor, assine antes de salvar.');
                return;
            }

            const dataURL = signaturePads[type].toDataURL();
            const canvas = document.getElementById(`signatureCanvas${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const controls = document.getElementById(`controls${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const status = document.getElementById(`status${type.charAt(0).toUpperCase() + type.slice(1)}`);

            canvas.setAttribute('data-signature', dataURL);
            signaturePads[type].off();
            
            controls.classList.add('hidden');
            status.classList.remove('hidden');
            
            showAlert('Sucesso', 'Assinatura salva e campo bloqueado! Você pode imprimir o documento.');
        }

        // --- FUNÇÕES DE IMPRESSÃO E SALVAR HTML ---

        function imprimirPagina() {
            const dataCliente = document.getElementById('nome_cliente').value;
            if (!dataCliente || dataCliente.trim() === "") {
                showAlert('Atenção', 'Preencha o **Nome do Cliente** na Página 1 antes de imprimir para garantir a validade do contrato.');
                return;
            }

            const clientCanvas = document.getElementById('signatureCanvasClient');
            const companyCanvas = document.getElementById('signatureCanvasCompany');
            
            const clientImg = document.createElement('img');
            clientImg.src = clientCanvas.getAttribute('data-signature') || (signaturePads.client.isEmpty() ? '' : signaturePads.client.toDataURL());
            clientImg.style.width = '100%';
            clientImg.style.height = '200px';
            clientImg.classList.add('print-only-signature');
            
            const companyImg = document.createElement('img');
            companyImg.src = companyCanvas.getAttribute('data-signature') || (signaturePads.company.isEmpty() ? '' : signaturePads.company.toDataURL());
            companyImg.style.width = '100%';
            companyImg.style.height = '200px';
            companyImg.classList.add('print-only-signature');

            const clientCanvasParent = clientCanvas.parentElement;
            const companyCanvasParent = companyCanvas.parentElement;
            
            if (!signaturePads.client.isEmpty() || clientCanvas.getAttribute('data-signature')) {
                clientCanvas.classList.add('print:hidden');
                clientCanvasParent.appendChild(clientImg);
            }
            if (!signaturePads.company.isEmpty() || companyCanvas.getAttribute('data-signature')) {
                companyCanvas.classList.add('print:hidden');
                companyCanvasParent.appendChild(companyImg);
            }

            window.print();

            clientCanvas.classList.remove('print:hidden');
            companyCanvas.classList.remove('print:hidden');
            if (clientImg.parentNode === clientCanvasParent) {
                clientCanvasParent.removeChild(clientImg);
            }
            if (companyImg.parentNode === companyCanvasParent) {
                companyCanvasParent.removeChild(companyImg);
            }
        }

        function salvarHtml() {
            showConfirm('Salvar Arquivo', 'O arquivo será salvo no formato HTML. Deseja continuar?', () => {
                const htmlContent = document.documentElement.outerHTML;
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Orcamento_Contrato_METALGLASS_${new Date().toISOString().slice(0, 10)}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showAlert('Sucesso', 'Arquivo HTML salvo com sucesso!');
            });
        }

        // --- FUNÇÕES DE MODAL CUSTOMIZADO (ALERT/CONFIRM) ---

        function showAlert(title, message) {
            document.getElementById('customAlertTitle').textContent = title;
            // Usa innerHTML para permitir o uso de tags HTML (como ** negrito)
            document.getElementById('customAlertMessage').innerHTML = message; 
            document.getElementById('customAlertModal').classList.remove('hidden');
        }

        function hideAlert() {
            document.getElementById('customAlertModal').classList.add('hidden');
        }

        function showConfirm(title, message, callback) {
            document.getElementById('customConfirmTitle').textContent = title;
            document.getElementById('customConfirmMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('customConfirmModal').classList.remove('hidden');
        }

        function acceptConfirm() {
            document.getElementById('customConfirmModal').classList.add('hidden');
            if (confirmCallback) {
                confirmCallback();
            }
        }

        function cancelConfirm() {
            document.getElementById('customConfirmModal').classList.add('hidden');
            confirmCallback = null;
        }

        // --- INICIALIZAÇÃO ---

        window.onload = () => {
            inicializarAssinaturas();
            atualizarDataHora();
            atualizarDadosContrato();
            adicionarLinha(); // Adiciona a primeira linha de item por padrão
            toggleContratoEdicao(false); // Bloqueia o contrato na inicialização
            
            // Redimensiona o canvas quando a janela muda
            window.onresize = () => {
                resizeCanvas(document.getElementById('signatureCanvasClient'));
                resizeCanvas(document.getElementById('signatureCanvasCompany'));
            };

            // Garante que todos os textareas sejam redimensionados corretamente
            document.querySelectorAll('.auto-resize').forEach(autoResizeTextarea);
        };
    </script>
</body>
</html>